name: Koyeb Keep Alive Fixed

on:
  schedule:
    - cron: '0 0 */10 * *'
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    steps:
      - name: Run Keep Alive & Notify
        shell: bash
        env:
          TOKENS_LIST: ${{ secrets.KOYEB_TOKENS }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          # --------------------------
          # 1. 安装 Koyeb CLI
          # --------------------------
          echo "正在安装 Koyeb CLI..."
          curl -s https://get.koyeb.com | bash
          
          # 定义绝对路径，防止 127 错误
          KOYEB_BIN="$HOME/.koyeb/bin/koyeb"
          
          # 检查是否安装成功
          if [ ! -f "$KOYEB_BIN" ]; then
            echo "❌ 错误: 找不到 Koyeb CLI 文件，安装可能失败。"
            exit 1
          fi
          
          echo "✅ CLI 安装成功，路径: $KOYEB_BIN"

          # --------------------------
          # 2. 检查 Telegram 配置
          # --------------------------
          TG_ENABLE="false"
          if [[ -n "$TG_BOT_TOKEN" && -n "$TG_CHAT_ID" ]]; then
            TG_ENABLE="true"
            echo "✅ Telegram 通知已启用"
          else
            echo "⚠️ 未检测到 Telegram 配置，跳过发送消息"
          fi

          # --------------------------
          # 3. 循环处理账号
          # --------------------------
          echo "$TOKENS_LIST" | while IFS= read -r token || [ -n "$token" ]; do
            # 过滤空行
            if [ -z "$token" ]; then continue; fi
            
            # 设置当前 Token
            export KOYEB_TOKEN=$(echo "$token" | xargs)
            
            echo "----------------------------------------"
            echo "正在连接 Koyeb API..."

            # 调用 API (使用绝对路径)
            OUTPUT=$("$KOYEB_BIN" organizations list --output json 2>&1)
            EXIT_CODE=$?

            # 解析结果
            if [ $EXIT_CODE -eq 0 ]; then
              # 成功：提取账号名
              ACCOUNT_NAME=$(echo "$OUTPUT" | jq -r '.[0].name // "Unknown"')
              STATUS="✅ 保活成功"
              DETAILS="账号: $ACCOUNT_NAME"
              echo "Success: [$ACCOUNT_NAME] 状态已刷新"
            else
              # 失败
              STATUS="❌ 保活失败"
              DETAILS="原因: Token 无效或网络错误 (Exit Code: $EXIT_CODE)"
              echo "Error Output: $OUTPUT"
            fi

            # 发送 Telegram 通知
            if [ "$TG_ENABLE" == "true" ]; then
              DATE=$(date "+%Y-%m-%d %H:%M:%S")
              # 简单的 URL 编码处理
              TEXT="$STATUS%0A$DETAILS%0A时间: $DATE"
              
              curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
                -d chat_id="$TG_CHAT_ID" \
                -d text="$TEXT" > /dev/null
            fi
            
            # 清理
            unset KOYEB_TOKEN
          done
