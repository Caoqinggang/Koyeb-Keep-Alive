name: Koyeb Keep Alive

on:
  schedule:
    # 每 10 天运行一次
    - cron: '0 0 */10 * *'
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    steps:
      - name: Run Keep Alive & Notify
        shell: bash
        env:
          TOKENS_LIST: ${{ secrets.KOYEB_TOKENS }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          # --------------------------
          # 1. 智能安装 Koyeb CLI
          # --------------------------
          echo "正在查询 Koyeb CLI 最新版本..."
          
          # 使用 GitHub API 获取最新发布的下载链接 (寻找包含 linux_amd64 和 tar.gz 的文件)
          DOWNLOAD_URL=$(curl -s https://api.github.com/repos/koyeb/koyeb-cli/releases/latest | \
            jq -r '.assets[] | select(.name | contains("linux_amd64")) | select(.name | contains("tar.gz")) | .browser_download_url' | head -n 1)
          
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
            echo "❌ 错误: 无法获取下载链接，可能是 GitHub API 限制或网络问题。"
            exit 1
          fi
          
          echo "最新版下载地址: $DOWNLOAD_URL"
          
          # 创建目录
          mkdir -p $HOME/.koyeb/bin
          
          # 下载
          echo "正在下载..."
          wget -q -O koyeb.tar.gz "$DOWNLOAD_URL"
          
          # 解压
          tar -xzf koyeb.tar.gz
          
          # 查找并移动二进制文件 (因为解压后的文件夹名通常带有版本号，使用 find 自动定位)
          find . -type f -name "koyeb" -exec mv {} $HOME/.koyeb/bin/koyeb \;
          
          # 赋予权限
          chmod +x $HOME/.koyeb/bin/koyeb
          KOYEB_BIN="$HOME/.koyeb/bin/koyeb"
          
          # 验证安装
          if [ ! -f "$KOYEB_BIN" ]; then
            echo "❌ 错误: 安装失败，未找到二进制文件。"
            exit 1
          fi
          
          echo "✅ 安装成功，版本: $("$KOYEB_BIN" version)"

          # --------------------------
          # 2. 检查 Telegram 配置
          # --------------------------
          TG_ENABLE="false"
          if [[ -n "$TG_BOT_TOKEN" && -n "$TG_CHAT_ID" ]]; then
            TG_ENABLE="true"
          else
            echo "⚠️ 未检测到 Telegram 配置，跳过通知。"
          fi

          # --------------------------
          # 3. 循环保活
          # --------------------------
          echo "$TOKENS_LIST" | while IFS= read -r token || [ -n "$token" ]; do
            if [ -z "$token" ]; then continue; fi
            
            export KOYEB_TOKEN=$(echo "$token" | xargs)
            
            echo "----------------------------------------"
            echo "正在连接账号..."

            # API 调用
            OUTPUT=$("$KOYEB_BIN" organizations list --output json 2>&1)
            EXIT_CODE=$?

            if [ $EXIT_CODE -eq 0 ]; then
              ACCOUNT_NAME=$(echo "$OUTPUT" | jq -r '.[0].name // "Unknown"')
              STATUS="✅ 保活成功"
              DETAILS="账号: $ACCOUNT_NAME"
              echo "Success: $ACCOUNT_NAME"
            else
              STATUS="❌ 保活失败"
              DETAILS="原因: Token 无效或网络错误 (Code: $EXIT_CODE)"
              echo "Error: $OUTPUT"
            fi

            # 发送通知
            if [ "$TG_ENABLE" == "true" ]; then
              DATE=$(date "+%Y-%m-%d %H:%M:%S")
              TEXT="$STATUS%0A$DETAILS%0A时间: $DATE"
              
              curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
                -d chat_id="$TG_CHAT_ID" \
                -d text="$TEXT" > /dev/null
            fi
            
            unset KOYEB_TOKEN
          done
